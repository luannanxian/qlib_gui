# Qlib图形化封装PRD文档 V1.2

## 一、项目背景

Qlib作为一款强大的量化投资研究框架，为用户提供了数据处理、策略构建、回测等丰富功能，但现有代码化操作模式对个人用户存在较高门槛：非编程背景用户难以直接上手，有基础编程能力的个人用户也需花费大量时间调试代码。本次图形化封装项目聚焦个人用户核心痛点，旨在通过可视化界面将Qlib的专业功能"平民化"——让新手无需代码即可完成从数据获取到策略验证的全流程，让资深用户通过拖拽配置快速迭代策略，最终实现个人量化投资研究效率的显著提升。

## 二、项目目标

- **降低使用门槛**：增设"新手模式/专家模式"切换；新手模式采用"引导式操作流程"，从数据导入到回测完成每步均有提示说明；预设10+经典策略模板（如双均线、布林带等），支持一键复用；专家模式开放全功能，支持自定义配置。通过"拖拽+勾选"的可视化操作替代90%以上的代码编写工作。

- **提升操作效率**：核心功能模块（数据-策略-回测）采用"线性流程+并行配置"布局，减少页面跳转；支持策略参数批量保存与快速切换，同一策略可保存5+参数组合版本；回测结果自动生成可视化报告，关键指标（年化收益、最大回撤等）突出展示。

- **覆盖核心功能**：完整映射Qlib v0.8+的核心能力，包括但不限于：1）数据层面：支持Qlib本地数据及本地文件导入；2）策略层面：涵盖技术指标计算、自定义因子构建、多条件逻辑组合；3）回测层面：支持日频/分钟频回测、交易成本精细化设置、多维度结果分析；**4）部署层面：当前版本专注于研究回测，模拟交易部署作为未来扩展功能**。

- **保证兼容性与扩展性**：与Qlib新版本保持同步更新（滞后不超过1个月）；预留"自定义代码插件"接口，自定义代码在隔离的本地Python虚拟环境中执行并限制依赖；支持导出策略的Qlib原生代码，便于进阶用户二次开发。

## 三、用户画像

| 用户类型 | 特征与使用场景 | 详细需求 |
|----------|----------------|----------|
| 量化投资新手 | 特征：无编程基础，了解基本金融概念，倾向"先模仿后创新"；场景：尝试验证简单策略（如均线交叉）、对比不同策略收益表现。 | 1. 提供"新手引导页"，含3步快速上手教程；2. 策略模板附带详细说明（逻辑原理、适用场景、参数含义）；3. 数据可视化支持"一键生成常用图表"（如K线+均线组合）；4. 回测结果提供"指标解读卡片"，用通俗语言解释夏普比率等专业术语。 |
| 有经验的量化投资者 | 特征：具备基础Python能力，熟悉量化策略逻辑，追求"效率与灵活度"；场景：快速迭代策略参数、构建自定义因子、多策略对比回测。 | 1. 支持自定义指标编写（提供代码编辑器，在受限的本地虚拟环境中调用Qlib原生函数）；2. 策略逻辑编辑支持"条件组嵌套"（如多指标联合判断）；3. 参数优化支持"自定义优化目标函数"；4. 回测结果支持"多策略横向对比"（同一图表展示不同策略净值曲线）。 |

## 四、核心功能需求

### 4.1 数据管理模块

- **数据导入**：
  1) **本地文件**：支持CSV/Excel格式，自动识别表头（如日期、开盘价等），用户可手动映射字段与Qlib标准字段，支持批量上传（单次最多10个文件）；
  2) **Qlib数据源**：下拉选择"中国A股""美股"等市场，勾选股票代码（支持按行业/市值筛选，可批量搜索添加），设置时间范围（精确到日），支持"历史数据全量同步"和"增量更新"；
  3) **第三方接口**：**移除Tushare API依赖**，保留接口架构为未来扩展预留；
  4) 导入后支持"数据预览"（前100行数据表格，可分页查看）、"数据校验"（提示缺失字段、数据格式错误、重复数据）及"一键修复"（如自动填充缺失的日期字段）。

- **数据预处理**：
  1) **缺失值处理**：提供"删除行""均值填充""中位数填充""前向填充"4种方式，支持按列选择处理范围，处理后展示"填充/删除数量统计"；
  2) **异常值处理**：支持"标准差法"（设置1-5倍标准差阈值）、"分位数法"（设置上下分位数）识别异常值，处理方式可选"替换为阈值""删除行"，**处理后生成"异常值分布热力图"**；
  3) **数据转换**：归一化（Min-Max、Z-Score）、标准化（保留两位小数）、数据类型转换（日期格式、数值格式），**对数据抽样后预览转换后的数据分布直方图**，支持"转换规则保存"（如自定义归一化范围）；
  4) **数据筛选**：支持"条件筛选"（如收盘价>10元、成交量>1000手，可添加多条件组合）和"时间范围筛选"，筛选条件可保存为模板（最多20个），支持"筛选结果对比"（原始数据与筛选后数据差异展示）。

- **数据可视化**：
  1) **基础图表**：K线图（支持蜡烛图/美国线切换，可叠加成交量副图）、均线图（可添加5/10/20/60日均线，支持自定义均线周期和颜色）、成交量图，支持缩放/平移查看，点击图表数据点显示"当日详细数据弹窗"；
  2) **指标图表**：MACD（可自定义快线/慢线周期、信号线颜色）、RSI（设置时间窗口，支持超买超卖区间标注）、KDJ（设置周期参数，金叉死叉自动标记），支持多指标同屏展示（最多3个指标），可拖拽调整指标顺序；
  3) **自定义图表**：用户选择X轴（日期/成交量等）、Y轴（收盘价/收益率等）字段，选择图表类型（折线图/柱状图/散点图），支持"图表样式自定义"（颜色、图例位置、坐标轴刻度）；
  4) **图表交互**：支持"指标标注"（在特定日期添加文字备注，支持上传图片附件）、"数据导出"（图表数据导出为CSV）、"图表保存"（PNG格式，可设置分辨率），支持"多图表联动"（如选中K线图某时间段，其他图表同步高亮该区间）。

### 4.2 策略构建模块

- **策略模板选择**：
  1) **模板分类**：按"趋势跟踪"（双均线、MACD）、"震荡策略"（RSI、布林带）、"多因子"（PE+PB+ROE）三大类划分，每类包含3-5个经典模板，首页展示"热门模板TOP5"（按使用量排序）；
  2) **模板详情**：每个模板展示"策略逻辑流程图"（可放大查看）、"核心参数说明"（带默认值和推荐范围）、"历史回测示例"（近3年回测结果，可切换市场和时间周期）；
  3) **模板操作**：支持"一键使用"（直接进入参数配置页）、"复制模板"（基于模板修改逻辑，生成新策略副本）、"收藏模板"（标记常用模板，上限10个）、"模板评价"（星级评分+文字评论）。

- **指标组件库**：
  1) **组件分类**：技术指标（MA、MACD等20+，按"趋势类""震荡类""量能类"子分类）、**Talib指标（集成TA-Lib库常用技术指标，如EMA、RSI、MACD、布林带、KDJ等40+，按TA-Lib官方分类梳理）**、财务指标（PE、PB等10+，支持按"盈利能力""偿债能力"筛选）、自定义因子（用户已保存的因子，带创建时间和使用次数）；
  2) **组件使用**：拖拽组件到编辑区，自动弹出参数配置面板（如MA的"时间窗口""价格类型"，Talib指标保留官方参数命名及默认值，带参数说明tooltip），支持实时预览指标计算结果（前20条数据），组件可"锁定"（防止误操作）和"批量删除"；
  3) **因子构建**：提供"因子编辑器"，支持通过"指标组合"（可视化公式编辑器，支持拖拽指标和运算符）或"Python代码编写"（在受控的本地虚拟环境中运行，提供代码补全、语法高亮、运行调试功能，可调用Qlib的Factor类）创建自定义因子，支持因子回测有效性验证（IC值计算、分层回测结果展示），因子可"发布到个人组件库"和"共享到社区（可选）"。

- **策略逻辑编辑**：
  1) **编辑界面**：左侧组件库、中间画布（逻辑流程图，支持放大缩小、网格对齐）、右侧参数面板，支持"画布保存快照"（最多5个快照版本，可回退）；
  2) **逻辑节点**：包含"指标计算节点""条件判断节点""交易信号节点"（买入/卖出，可设置信号强度权重）、"仓位控制节点"（如固定仓位50%、动态仓位（根据波动率调整））、"止损止盈节点"（支持"百分比止损""均线止损""固定金额止盈"）；
  3) **连接规则**：条件判断节点支持"单条件"（如MACD金叉）或"多条件组合"（如MACD金叉且RSI<30，支持"与/或/非"逻辑运算符，**原则上支持多层嵌套，建议不超过5层以保障可读性**），节点连接后自动生成"逻辑说明文本"（如"当MACD金叉且RSI<30时，触发买入信号"）；
  4) **逻辑校验**：系统自动检查逻辑漏洞（如无卖出信号、仓位超过100%、止损价高于买入价），并**高亮显示"错误位置定位"和"修改建议"，需用户手动确认修复**。

- **参数优化**：
  1) **参数设置**：选择需优化的参数（如MA短期窗口5-20、长期窗口20-60），设置步长（如1），支持"参数联动设置"（如长期窗口始终大于短期窗口）；
  2) **优化配置**：选择优化算法（网格搜索/随机搜索，随机搜索可设置迭代次数）、优化目标（夏普比率最大化/最大回撤最小化/年化收益最大化，支持多目标权重配置）、约束条件（如最大回撤<20%、胜率>50%）；
  3) **结果展示**：生成"参数热力图"（展示不同参数组合的目标值，支持颜色深浅区分）、"最优参数组合列表"（按目标值排序，展示前10组）、"参数敏感性曲线"（单参数变化对目标值的影响趋势），支持一键应用最优参数到策略，或对比不同参数组合的回测结果；
  4) **性能提示**：**明确提示复杂优化耗时较长，提供"任务队列"和"后台运行"功能**，管理用户预期。

### 4.3 回测分析模块

- **回测参数设置**：
  1) **基础参数**：回测时间范围（精确到日）、初始资金（默认10万元，可自定义，上限1000万元）、股票池（选择已导入的数据或直接勾选市场标的，支持"排除ST股""排除次新股"筛选）；
  2) **交易成本**：手续费（默认0.03%，可设置按比例/固定金额，支持分市场设置）、印花税（默认0.1%，仅卖出时收取，可关闭）、滑点（默认0.1%，可设置按比例/固定价差，支持"动态滑点"（根据成交量调整））；
  3) **特殊设置**：支持"涨跌停限制"（默认开启，可选择"严格遵循"或"忽略"）、"流动性过滤"（如成交量低于500手不交易，可自定义阈值）、"单只股票仓位上限"（如不超过总资金20%，可自定义）、"最大持仓数量"（如最多持仓10只股票，可自定义）。

- **回测执行与监控**：
  1) **执行控制**：一键启动回测，支持"暂停"（**仅中断计算不修改参数，保留当前进度**）、"终止"（生成部分结果，标注"回测未完成"）；
  2) **进度监控**：展示回测完成百分比、当前处理日期、剩余时间预估（基于已处理数据耗时计算），支持"后台回测"（关闭页面不中断回测，通过桌面通知提示完成）；
  3) **日志输出**：实时打印回测日志（如"2023-01-05 买入贵州茅台 100股，成交价1700元"），支持日志筛选（按交易类型/日期/标的）、日志搜索（关键词匹配）和日志导出（TXT格式）。

- **回测结果展示**：
  1) **核心指标表**：包含累计收益率、年化收益率、夏普比率、最大回撤、胜率、盈亏比等15+指标，支持"指标对比基准"（如沪深300、上证指数），指标旁带"指标解读"小图标；
  2) **可视化图表**：净值曲线（对比基准指数，支持叠加多个策略曲线）、回撤曲线（标记最大回撤点及日期，点击查看该时段交易明细）、月度收益柱状图（红色负收益/绿色正收益）、持仓分布饼图（按行业/标的），所有图表支持"时间段缩放"和"数据点详情查看"；
  3) **交易明细**：展示每笔交易的标的、日期、价格、数量、盈亏金额、手续费、持仓天数，支持按"盈亏金额排序"和"标的筛选"；
  4) **结果导出**：支持导出"指标表（Excel）""图表（PNG，分辨率可选）""完整报告（PDF，含图表+明细+诊断）"，报告支持"自定义封面"和"添加备注"。

- **策略诊断**：
  1) **收益分析**：分析"收益来源"（单只标的贡献度TOP5、行业分布贡献占比）、"收益稳定性"（月度收益标准差、连续盈利/亏损月数）、"收益时段分布"（哪个季度/月份收益最高）；
  2) **风险分析**：识别"最大回撤时段"及对应的市场环境（如大盘下跌幅度）、"波动风险"（年化波动率、收益波动系数）、"尾部风险"（极端行情下的收益表现）；
  3) **过拟合检测**：通过"样本外测试"（预留20%数据验证，展示样本内/外收益差异）、"参数敏感性分析"（参数±10%变动时的收益变化率）、"Walk Forward检验"（滚动窗口回测，展示策略稳定性）；
  4) **优化建议**：针对诊断问题给出具体可操作建议（如"减少单一行业持仓占比至15%以下""将MA短期窗口参数范围扩大至5-30以降低敏感性""添加波动率止损条款"）。

### 4.4 策略部署模块（未来扩展）

- **当前版本说明**：**V1.2版本专注于研究回测功能，模拟交易部署将在后续版本中提供**；
- **架构预留**：为未来对接第三方模拟交易平台（如同花顺模拟盘、通达信模拟盘）预留接口设计；
- **基础监控**：保留策略监控与告警功能设计，用于回测结果的持续跟踪分析。

## 五、技术架构要点

### 5.1 本地自建Web部署方案

- **整体结构**：
  - 后端：FastAPI（或等价Python框架）运行在本地Python 3.9+虚拟环境中，暴露REST API与WebSocket接口。
  - 前端：React/Next.js应用，开发阶段通过`npm run dev`热更新，生产阶段由后端提供静态托管或通过反向代理统一到`127.0.0.1`端口。
  - 任务调度：默认串行执行回测任务，可选开启最多2个并行任务（需提醒用户关注本机资源占用）。

- **运行方式**：
  - 提供一键启动脚本（或Makefile命令）同时启动前后端服务，并在日志中输出可访问地址（默认`http://127.0.0.1:3000`）。
  - 数据目录及实验结果均存放在服务端，可通过配置文件自定义路径。

- **自定义代码执行策略**：
  - 自定义因子/策略代码在专用的Python虚拟环境中运行，与主后端环境隔离。
  - 限制可导入的模块列表，执行前进行基础静态检查（禁止`os.system`、`subprocess`等高风险调用）。
  - 执行完成后清理临时文件与缓存，避免残留影响后续运行。

- **硬件及性能建议**：
  - 推荐机器配置：4核CPU、≥16GB内存、SSD磁盘。
  - 当并行回测占用资源过高时，通过界面提示用户改为串行模式或调整回测参数（如缩短数据区间）。

### 5.2 数据源架构

- **简化数据接入**：
  - 移除Tushare等第三方API依赖，降低外部服务不稳定风险
  - 专注于Qlib原生数据源的质量和稳定性
  - 优化本地文件导入的数据校验和修复能力
  - 为未来数据源扩展保持架构灵活性

## 六、非功能需求

### 6.1 性能需求

**性能目标（视策略复杂度与硬件配置而定）**：

- 处理50万条以上数据时，数据导入和预处理的响应时间**争取不超过30秒**；
- 单策略回测（时间范围为5年，股票池包含200只股票）的完成时间**争取不超过10分钟**；
- 系统支持同时进行2-3个策略的并行回测；
- 复杂计算任务提供清晰的进度提示和预计完成时间。

### 6.2 安全性需求

- **代码执行安全**：自定义代码在独立的本地Python虚拟环境中执行，限制可用模块并禁止访问敏感目录；
- **操作安全**：关键操作（如数据删除、策略覆盖）需要二次确认；

### 6.3 易用性需求

1) **界面布局**：采用"顶部导航栏（功能模块）+左侧工具栏（快捷操作）+中间工作区（核心功能）+右侧属性面板（参数配置）"结构，核心功能模块（数据、策略、回测）入口在导航栏置顶；
2) **操作流程**：关键流程（如"数据导入-策略构建-回测"）提供"线性引导"，每步操作有"下一步建议"提示；
3) **帮助体系**：每个功能页面右上角有"？"帮助按钮，点击弹出"功能说明+操作示例"；提供常见问题解答（如"数据导入失败原因""回测结果异常排查"）；
4) **错误提示**：操作错误时弹出"错误类型+原因分析+解决步骤"，如"数据导入失败：文件格式错误，请确保为CSV/Excel格式，且表头包含'日期''收盘价'字段"。

### 6.4 兼容性需求

- 前端浏览器：Chrome 100+/Edge 100+/Firefox 100+/Safari 15+；
- 后端运行环境：Windows 10+/macOS 12+/主流Linux发行版，Python 3.9-3.11，Node.js 18+；
- 与Qlib 0.8及以上版本兼容。

## 八、风险评估与缓解

### 8.1 技术风险

- **自定义代码隔离风险**：
  - 风险：用户自定义代码可能误用系统资源或访问敏感文件
  - 缓解：限制可导入模块、执行前做静态检查、执行后清理临时目录，并提供样例模板引导规范编写

- **跨平台兼容性**：
  - 风险：不同操作系统上的依赖版本、文件路径及权限差异导致部署失败
  - 缓解：在Windows/macOS/Linux上分别验证脚本与依赖，提供分步安装指南和常见问题排查文档

### 8.2 功能风险

- **模拟交易功能缺失**：
  - 风险：用户期望完整的量化研究到实盘流程
  - 缓解：明确当前版本定位为研究平台，在文档和界面中清晰说明，规划后续版本路线图

- **数据源有限**：
  - 风险：相比竞品数据源较少
  - 缓解：优先保证核心数据质量，提供完善的数据导入功能，为未来数据源扩展预留架构

### 8.3 项目风险

- **开发周期紧张**：
  - 风险：功能复杂度高，开发时间估计不足
  - 缓解：严格遵循MVP原则，优先保证核心闭环的稳定性，非核心功能放到后续迭代

## 九、开发与测试原则

- **TDD（测试驱动开发）流程**：
  - 所有核心业务逻辑、API 端点、数据转换函数需先编写失败的单元测试/集成测试，再实现最小满足需求的代码，最后重构；
  - 后端使用 `pytest` 编写测试，覆盖率目标≥80%；前端使用 `vitest`/`jest` 针对关键组件与状态逻辑编写测试；
  - 每个缺陷修复需先新增失败测试复现问题，再提交修复（防止回归）；
  - CI 流程（或本地脚本）默认执行 `lint → test → build`，测试失败时禁止合并；
  - 提供测试夹具（fixtures）模拟常见数据场景，如无数据、本地文件导入失败、回测超时等，鼓励在 TDD 周期中复用。
